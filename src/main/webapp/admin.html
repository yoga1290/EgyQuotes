<!DOCTYPE html>
<html lang="en">
	<head>
	    <meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	    <title>EgyQuotes</title>
		<script src="//code.jquery.com/jquery.js"></script>
<!--		<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular.min.js"></script> -->
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
		<!-- Optional theme -->
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
		
		<link rel="stylesheet" href="//cdn.datatables.net/1.10.5/css/jquery.dataTables.min.css">
		<script src="//cdn.datatables.net/1.10.5/js/jquery.dataTables.min.js"></script>
		
		<!-- Latest compiled and minified JavaScript -->
		<script src="//netdna.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jade/1.3.1/jade.min.js"></script>
		
		
	</head>
		<body style='background-color: #f9faf7;' align="center">
<script type="jade" id="jade">
.navbar.navbar-default.navbar-static-top
	.container
		.navbar-brand EgyQuotes
		button.navbar-toggle.col-xs-3(data-toggle="collapse",data-target=".navbar-collapse")
			span.glyphicon.glyphicon-option-horizontal(style="font-size:32px")
		ul.nav.navbar-nav.navbar-right.collapse.navbar-collapse
			il
				button#loginbtn.btn.btn-primary.btn-lg(onclick="location.href='https://www.facebook.com/dialog/oauth?client_id=1048399691842414&redirect_uri=https://egyquotes.appspot.com/FBUser/&scope=email&state=admin';") Login via Facebook
.container-fluid
	.row
		table#Quote.table
	.row
		table#User.table
</script>
<script>
var YTSvc={
		key:"AIzaSyBNWNnIBvHyBaREu7ikXf7jqW_865D4CD0",
        data:{channel:{title:'',thumbnail:'',id:-1},id:-1,thumbnail:'',title:''},
        callBackFn:function(d){},
		getData:function(videoId,callBackFn){
            //YTSvc.data={channel:{title:'',thumbnail:'',id:-1},id:-1,thumbnail:'',title:''};
            //YTSvc.callBackFn=callBackFn;
            var data={channel:{title:'',thumbnail:'',id:-1},id:-1,thumbnail:'',title:''};
            
			$.ajax({
				url:"https://www.googleapis.com/youtube/v3/videos?id="+videoId+"&key="+YTSvc.key
                    +"&part=snippet",
                type:'GET',
                success:function(response){
                        //YTSvc.data.title=data.items[0].snippet.title;
                        //YTSvc.data.thumbnail=data.items[0].snippet.thumbnails.default.url;
                        //YTSvc.data.id=data.items[0].id;
                        data.title=response.items[0].snippet.title;
                        data.thumbnail=response.items[0].snippet.thumbnails.default.url;
                        data.id=response.items[0].id;
                        var channelId=response.items[0].snippet.channelId;
	                	$.ajax({
	                		url:'https://www.googleapis.com/youtube/v3/channels?part=snippet&id='+channelId+'&key='+YTSvc.key,
	                		type:'GET',
                            success:function(response){
	                			YTSvc.data.channel.title=response.items[0].snippet.title;
                                data.channel.thumbnail=response.items[0].snippet.thumbnails.default.url;
                                data.channel.id=response.items[0].id;
                                callBackFn(data);
	                		}
	                	});
                }
			});
		},
		getChannelData: function(channelId,callback){
			$.ajax({
	        		url:'https://www.googleapis.com/youtube/v3/channels?part=snippet&id='+channelId+'&key='+YTSvc.key,
	        		type:'GET',
	                success:function(data){
	                		callback({
	                    		id: data.items[0].id,
	                    		title: data.items[0].snippet.title,
	                    		thumbnail: data.items[0].snippet.thumbnails.default.url
	                    });
	        		}
        		});
		}
};

var dataTable_quote={
		api:{},
		table:{},
		order:'asc',
		colName:'',
		
		videoId:[],
		thumbnailURL:{},
		curThumbnail:0,
		updateChannelThumbnail:function(){
			if(dataTable_quote.curThumbnail<dataTable_quote.videoId.length)
			{
				YTSvc.getData(dataTable_quote.videoId[dataTable_quote.curThumbnail],function(response){
					dataTable_quote.thumbnailURL[response.id]=response.channel.thumbnail;
					dataTable_quote.curThumbnail++;
					dataTable_quote.updateChannelThumbnail();
				});
			}else{
				$(dataTable_quote.table).find('td.videoId').each(function(i,td){
					var row=dataTable_quote.api.row($(td).parent()).data();
					if(row==undefined || row==null) return;
					
					var videoId=row.properties.videoId;
					$(td).html('<a href="http://youtu.be/'+videoId+'?t='+row.properties.start+'s"><img src="'+dataTable_quote.thumbnailURL[videoId]+'" /></a>');
				});
			}
		},
		init:function(table){
			dataTable_quote.table=table;
			dataTable_quote.api=$(table).DataTable({
				processing:true,
				serverSide:true,
				//scrollY:'200px',
				ajax:
				{
					url:'/Quote/DataTable',
					type:'POST',
					data:function(d){
						// see https://datatables.net/examples/server_side/custom_vars.html
						d.order=dataTable_quote.order;
						d.colName=dataTable_quote.colName;
					}
				},
				preDrawCallback:function(settings){
					var api=$('#Quote').DataTable();
					var ind=api.order()[0][0];
					dataTable_quote.order=api.order()[0][1];
					var colName=api.column(ind).dataSrc();
						colName=colName.substring(colName.lastIndexOf('.')+1,colName.length);
					dataTable_quote.colName=colName;
				},
				drawCallback:function(settings){
					
					$(dataTable_quote.table).find('td.videoId').each(function(i,td){
						var row=dataTable_quote.api.row($(td).parent()).data();
						dataTable_quote.videoId.push(row.properties.videoId);
						//dataTable_quote.updateChannelThumbnail(td,row.properties.videoId);
						//tds.push(td);
						/*
						YTSvc.getData(row.properties.videoId,function(response){
							$(tds[i]).html('<a href="http://youtu.be/'+videoId[i]+'"><img src="'+response.channel.thumbnail+'" /></a>');
						});//*/
					});
					dataTable_quote.curThumbnail=0;
					dataTable_quote.updateChannelThumbnail();
					/* $(dataTable_quote.table).find('td.videoId').each(function(i,td){
							YTSvc.getData(videoId[i],function(response){
								$(tds[i]).html('<a href="http://youtu.be/'+videoId[i]+'"><img src="'+response.channel.thumbnail+'" /></a>');
							});
					}); */
				},
				columns:[ 
				          /*
				          {
		                    title:'Edit',
		                "class":          "edit",
		                "orderable":      false,
		                "data":           null,
		                "defaultContent": "Edit"
		                },
		                {
		                    title:'Delete',
		                "class":          "delete",
		                "orderable":      false,
		                "data":           null,
		                "defaultContent": "Delete"
		                },
		                //*/
		                {data:'properties.personId',title:'صاحب المقولة'},
		                {data: "properties.quote", title:"المقولة"},
		                {data: "properties.videoId", title:"المصدر",className:'videoId'}
		                /*,
						{data: "properties.videoId", title:"videoId"},
						{data: "properties.quote", title:"quote"},
						{data: "properties.start", title:"start"},
						{data: "properties.end", title:"end"} //*/
					]
				});
		}
};

var dataTable_user={
		api:{},
		table:{},
		order:'asc',
		colName:'',
		
		
		init:function(table){
			dataTable_user.table=table;
			dataTable_user.api=$(table).DataTable({
				processing:true,
				serverSide:true,
				//scrollY:'200px',
				ajax:
				{
					url:'/FBUser/DataTable?access_token='+localStorage.getItem('access_token'),
					type:'POST',
					data:function(d){
						// see https://datatables.net/examples/server_side/custom_vars.html
						d.order=dataTable_user.order;
						d.colName=dataTable_user.colName;
					}
				},
				preDrawCallback:function(settings){
					var api=$('#User').DataTable();
					var ind=api.order()[0][0];
					dataTable_quote.order=api.order()[0][1];
					var colName=api.column(ind).dataSrc();
						colName=colName.substring(colName.lastIndexOf('.')+1,colName.length);
					dataTable_quote.colName=colName;
				},
				drawCallback:function(settings){
					
				},
				columns:[ 
				         /*
				          {
		                    title:'Edit',
		                "class":          "edit",
		                "orderable":      false,
		                "data":           null,
		                "defaultContent": "Edit"
		                },
		                {
		                    title:'Delete',
		                "class":          "delete",
		                "orderable":      false,
		                "data":           null,
		                "defaultContent": "Delete"
		                },//*/
		                {data: "key.name", title:"Id"}
					]
				});
		}
};

$(function(){
	
	$("body").html(
		    jade.render($('#jade').html(), {})
		  );
	
	dataTable_quote.init($('#Quote'));
	dataTable_user.init($('#User'));  
	
	    
	
	
	if(location.href.indexOf('access_token')>-1)
		localStorage.setItem('access_token',
				location.href.substring(location.href.indexOf('access_token=')+13,location.href.length));
	
	if(localStorage.getItem('access_token')!=null
			&& localStorage.getItem('access_token')!=undefined)
		$.ajax({
			url:'https://graph.facebook.com/me?access_token='+localStorage.getItem('access_token'),
			type:'GET',
			success:function(response){
				$('#loginbtn').text(response.name);
				$('#loginbtn').removeClass('btn-primary');
				$('#loginbtn').addClass('btn-default');
				$('#loginbtn').click(function(){
					localStorage.setItem('access_token','');
					$(this).text('Logged out');
				});
				$('#loginbtn').mouseover(function(){
					$(this).text('Log out');
				});
				$('#loginbtn').mouseup(function(){
					$(this).text(response.name);
				});
		    }
		});
});

</script>
  </body>
  </html>