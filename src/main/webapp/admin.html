<script src="//cdnjs.cloudflare.com/ajax/libs/jade/1.3.1/jade.min.js"></script>
<script type="jade" id="jade">
html
	head
		meta(charset="utf-8")
		meta(http-equiv="X-UA-Compatible",content="IE=edge")
		meta(name="viewport",content="width=device-width, initial-scale=1, maximum-scale=1")
		title EgyQuotes
		script(src="//code.jquery.com/jquery.js")
		link(rel="stylesheet",href="https://fonts.googleapis.com/icon?family=Material+Icons")
		link(rel="stylesheet",href="/glyphicons/glyphicons.css")
		link(rel="stylesheet",href="/css/animate.css")
		link(rel="stylesheet",href="//netdna.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css")
		link(rel="stylesheet",href="/css/style.css")

		script(src="//netdna.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js")
		link(rel="stylesheet" href="//cdn.datatables.net/1.10.5/css/jquery.dataTables.min.css")
		script(src="//cdn.datatables.net/1.10.5/js/jquery.dataTables.min.js")
		link(rel="stylesheet" href="//cdn.datatables.net/plug-ins/f2c75b7247b/integration/bootstrap/3/dataTables.bootstrap.css")
		script(src="//cdn.datatables.net/plug-ins/f2c75b7247b/integration/bootstrap/3/dataTables.bootstrap.js")
		
		
		script(src="/js/lib/jquery.noty.packaged.min.js")

		script(src="/js/lib/tokenizer.min.js")
		link(rel="stylesheet" href="/css/tokenizer.css")
	body
		.navbar.navbar-default.navbar-static-top
			.container
				.navbar-brand EgyQuotes
				button.navbar-toggle.col-xs-3(data-toggle="collapse",data-target=".navbar-collapse")
					span.glyphicon.glyphicon-option-horizontal(style="font-size:32px")
				ul.nav.navbar-nav.navbar-right.collapse.navbar-collapse
					il
						button#loginbtn.btn.btn-primary.btn-lg(onclick="location.href='https://www.facebook.com/dialog/oauth?client_id=1048399691842414&redirect_uri=https://egyquotes.appspot.com/FBUser/&scope=email&state=admin';") Login via Facebook
		.container-fluid
			.row
				table#Quote.table
			.row
				table#datatable_QuoteOwner.table
				
		script.
			var datatable_QuoteOwner={
				api:{},
				table:{},
				DDL:{},
				DDL_KVC:{},
				order:'asc',
				colName:'',
				getEditTemplate:function(row){
					return '<form onsubmit="return false;"><table>'

			+'<tr><td>userId</td><td><input type="text" name="userId" value="'+row.userId+'" ></td></tr>'
								+'<tr>'
									+'<td colspan="2"><button onclick="datatable_QuoteOwner.actions.edit('+row.quoteId+',$(this).closest(\'form\'));">Update</button></td>'
								+'</tr>'
							+'</table></form>';
				},
				getInsertTemplate:function(){
					return '<form onsubmit="return false;"><table>'

								+'<tr>'
									+'<td colspan="2"><button onclick="datatable_QuoteOwner.actions.insert($(this).closest(\'form\'));">Insert</button></td>'
								+'</tr>'
							+'</table></form>';
				},
				bindTemplateDDL:function(Template){
					$(Template).find('select').each(function(i,o){
						var name=$(this).attr('name');
						var i,html="";
						if(datatable_menu.DDL[name+""]!=undefined)
						for(i=0;i<datatable_menu.DDL[name+""].length;i++)
							html+="<option value='"+datatable_menu.DDL[name+""][i][""+datatable_menu.DDL_KVC[name+""].key]+"'>"+datatable_menu.DDL[name+""][i][""+datatable_menu.DDL_KVC[name+""].value]+"</option>";
						$(this).html(html);
					});
				},
				bindEditTemplateDDL:function(){
					$('#datatable_QuoteOwner tbody tr select').each(function(i,o){
						var name=$(this).attr('name');
						var i,html="";
						//var row=$(o).parent().parent().parent().parent().parent().parent().parent().prev();
						var row=$(o).parents('tr').last().prev();
						var data=datatable_QuoteOwner.api.row(row).data();
						if(datatable_QuoteOwner.DDL[name+""]!=undefined)
						for(i=0;i<datatable_QuoteOwner.DDL[name+""].length;i++)
						{
							if(data[name+""]==datatable_QuoteOwner.DDL[name+""][i][""+datatable_QuoteOwner.DDL_KVC[name+""].key])
								html+="<option value='"+datatable_QuoteOwner.DDL[name+""][i][""+datatable_QuoteOwner.DDL_KVC[name+""].key]+"' selected>"+datatable_QuoteOwner.DDL[name+""][i][""+datatable_QuoteOwner.DDL_KVC[name+""].value]+"</option>";
							else
								html+="<option value='"+datatable_QuoteOwner.DDL[name+""][i][""+datatable_QuoteOwner.DDL_KVC[name+""].key]+"'>"+datatable_QuoteOwner.DDL[name+""][i][""+datatable_QuoteOwner.DDL_KVC[name+""].value]+"</option>";
						}
						$(this).html(html);
					});
				},
				bindEditTemplate:function(row,template){
					//TODO: Bind DDL; find elements by form name (template.find('[name=IsDeleted]'))
					template.find('input[mask]').each(function(i,o){
						$(o).mask($(o).attr('mask'));
					});
					template.find('.datepicker').each(function(i,o){
						$(o).datepicker("option", "dateFormat", "Y-m-d H:i:s" );
					});


				},
				actions:{
					insert:function(form){
						QuoteOwnerSvc.insertForm(form,function(){
							datatable_QuoteOwner.api.draw(false);
							datatable_QuoteOwner.setListeners();
						});
					},
					edit:function(id,form){

						QuoteOwnerSvc.updateForm(id,form,function(){
							datatable_QuoteOwner.api.draw(false);
							datatable_QuoteOwner.setListeners();
						});

						$(datatable_QuoteOwner.table).find(' tr.selected').each(function(i,o){
							$(o).removeClass('selected');
						});
					},
					delete:function(o){
						var quoteId
								=datatable_QuoteOwner.api.row($(o).closest('tr'))
									.data().quoteId;

							QuoteOwnerSvc.delete(quoteId,function(){
								//de-select the item(s)
								$(datatable_QuoteOwner.table).find(' tr.selected')
									.each(function(i,o){
										$(o).removeClass('selected');
								});
								datatable_QuoteOwner.api.draw(false);
								datatable_QuoteOwner.setListeners();
							});


					},
					deleteAll:function(){
						var quoteId=[];
						$(datatable_QuoteOwner.table).find(' tr.selected').each(function(i,o){
							$(o).removeClass('selected');

							quoteId
								.push(
									datatable_QuoteOwner.api.row($(o))
									.data().quoteId
									);
						});
						QuoteOwnerSvc.deleteAll(quoteId,function(){
								//de-select the item(s)
								$(datatable_QuoteOwner.table).find(' tr.selected')
									.each(function(i,o){
										$(o).removeClass('selected');
								});
								datatable_QuoteOwner.api.draw(false);
								datatable_QuoteOwner.setListeners();
							});
					}
				},
				setListeners:function(){
					$(datatable_QuoteOwner.table).find( ' tbody').off();
					$(datatable_QuoteOwner.table).find( ' tbody').on('click','tr td.edit',function(){
						var row=datatable_QuoteOwner.api.row($(this).closest('tr'));
						debug=row;
						if(row.child.isShown())
							row.child.hide();
						else
						{
							row.child(
									datatable_QuoteOwner.getEditTemplate(row.data())
								).show();
							datatable_QuoteOwner.bindEditTemplate(row.data(),row.child());
						}
					});
					$(datatable_QuoteOwner.table).find( ' tbody').on('click','tr td.delete',function(){
						datatable_QuoteOwner.actions.delete(this);
					});
					$(datatable_QuoteOwner.table).find( ' tbody').on('click','tr[role=row]',function(){
						$(this).toggleClass('selected');
					});
					$(datatable_QuoteOwner.table).find( ' td.checkbox').off().each(function(i,o){
						$(o).html('<input type="checkbox" '+
							( datatable_QuoteOwner.api.cell($(o)).data()=='1' ? 'checked':'')
							+' disabled/>');
					});
					$(datatable_QuoteOwner.table).find( ' td.needsDataBind').each(function(i,cell){
						var id=datatable_QuoteOwner.api.cell($(cell)).data();
						var colInd=datatable_QuoteOwner.api.cell(cell)[0][0].column;
						var colTitle=$(datatable_QuoteOwner.api.column(colInd).header()).text();



					});
				},

				init:function(table){
					datatable_QuoteOwner.table=$(table);
					datatable_QuoteOwner.api=
						$(datatable_QuoteOwner.table).DataTable({
							processing:true,
							serverSide:true,
							//scrollY:'200px',
							ajax:
							{
								url:'/quoteowner/DataTable/admin',
								type:'POST',
								data:function(d){
									// see https://datatables.net/examples/server_side/custom_vars.html
									d.order=datatable_QuoteOwner.order;
									d.colName=datatable_QuoteOwner.colName;
									d.access_token=localStorage.getItem('access_token');
								}
							},
							drawCallback:function(settings){
								datatable_QuoteOwner.setListeners();
							},
							columns:[ {
										title:'Edit',
									"class":          "edit",
									"orderable":      false,
									"data":           null,
									"defaultContent": "Edit"
									},
									{
										title:'Delete',
									"class":          "delete",
									"orderable":      false,
									"data":           null,
									"defaultContent": "Delete"
									},
									//TODO:
									{data:'properties.userId',title:'صاحب المقولة',"orderable":true, className:'search'},
									{data:'key.name',title:' المقولة',"orderable":false, className:'needsDataBind'}

						]

					});

				}
			};
			datatable_QuoteOwner.init('#datatable_QuoteOwner');


</script>
<script>
window.onload=function(){

		document.write(
			jade.render(
				document.getElementById('jade').innerHTML,
				{pretty:'\t'}
			)
		);
		//AngularJS DOES NOT WORK W/OUT THIS:
		document.close();
};
</script>